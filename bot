from telegram import Update, InlineKeyboardButton, InlineKeyboardMarkup
from telegram.ext import Updater, CommandHandler, CallbackQueryHandler, MessageHandler, Filters
from telegram.ext import CallbackContext
from telegram import KeyboardButton, ReplyKeyboardMarkup


TOKEN = "6151381595:AAHSJcPw4-YY3jCiBF5NYYy-toOs8eeqXp8"

def start(update: Update, context):
    keyboard = [[InlineKeyboardButton("EN", callback_data='en'),
                 InlineKeyboardButton("RU", callback_data='ru')]]

    reply_markup = InlineKeyboardMarkup(keyboard)
    update.message.reply_text('–í—ã–±–µ—Ä–∏—Ç–µ —è–∑—ã–∫ / Choose a language:', reply_markup=reply_markup)

def language_callback(update: Update, context):
    query = update.callback_query
    lang = query.data

    # —Å–æ—Ö—Ä–∞–Ω—è–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–π —è–∑—ã–∫ –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    context.user_data['lang'] = lang

    if lang == 'en':
        message = 'Welcome! Here are the available options:'
        keywords_button_text = 'Keywords'
        add_keywords_button_text = 'Add new keywords'
        delete_all_keywords_button_text = 'Delete all keywords'
        chats_button_text = 'Chats'
        add_chats_button_text = 'Add new chats'
        back_button_text = 'Back'
    else:
        message = '–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å! –í–æ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã–µ –æ–ø—Ü–∏–∏:'
        keywords_button_text = '–ö–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞'
        add_keywords_button_text = '–î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–µ –∫–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞'
        delete_all_keywords_button_text = '–£–¥–∞–ª–∏—Ç—å –≤—Å–µ –∫–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞'
        chats_button_text = '–ß–∞—Ç—ã'
        add_chats_button_text = '–î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–µ —á–∞—Ç—ã'
        back_button_text = '–ù–∞–∑–∞–¥'

    keyboard = [[InlineKeyboardButton(keywords_button_text, callback_data='keywords'),
                 InlineKeyboardButton(chats_button_text, callback_data='chats')]]

    reply_markup = InlineKeyboardMarkup(keyboard)
    query.edit_message_text(message, reply_markup=reply_markup)

def keywords_callback(update: Update, context):
    lang = context.user_data.get('lang', 'en')

    if lang == 'en':
        message = 'Here are your keywords:'
        add_keywords_button_text = 'Add new keywords'
        delete_all_keywords_button_text = 'Delete all keywords'
        back_button_text = 'Back'
    else:
        message = '–í–æ—Ç –≤–∞—à–∏ –∫–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞:'
        add_keywords_button_text = '–î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–µ –∫–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞'
        delete_all_keywords_button_text = '–£–¥–∞–ª–∏—Ç—å –≤—Å–µ –∫–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞'
        back_button_text = '–ù–∞–∑–∞–¥'

    keywords = context.user_data.get('keywords', [])

    if keywords:
        keywords_list = '\n'.join(keywords)
        reply_markup = InlineKeyboardMarkup([[InlineKeyboardButton(add_keywords_button_text, callback_data='add_keywords')],
                                              [InlineKeyboardButton(delete_all_keywords_button_text, callback_data='delete_all_keywords')],
                                              [InlineKeyboardButton(back_button_text, callback_data='back')]])
        update.callback_query.edit_message_text(f"{message}\n{keywords_list}", reply_markup=reply_markup)
    else:
        reply_markup = InlineKeyboardMarkup([[InlineKeyboardButton(add_keywords_button_text, callback_data='add_keywords')],
                                              [InlineKeyboardButton(back_button_text, callback_data='back')]])
        update.callback_query.edit_message_text(f"{message}\n–í—ã –µ—â–µ –Ω–µ –∑–∞–¥–∞–ª–∏ –Ω–∏ –æ–¥–Ω–æ–≥–æ —Å–ª–æ–≤–∞ –¥–ª—è –ø–æ–∏—Å–∫–∞. –ß—Ç–æ–±—ã –¥–æ–±–∞–≤–∏—Ç—å –∏—Ö, –Ω–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É ¬´–î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–µ –∫–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞¬ª.", reply_markup=reply_markup)

def add_keywords_callback(update: Update, context):
    lang = context.user_data.get('lang', 'en')

    if lang == 'en':
        message = 'Please enter the keywords or phrases you want to search for, separated by a comma:'
        back_button_text = 'Back'
    else:
        message = '–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –∫–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞ –∏–ª–∏ —Ñ—Ä–∞–∑—ã, –∫–æ—Ç–æ—Ä—ã–µ –≤—ã —Ö–æ—Ç–∏—Ç–µ –Ω–∞–π—Ç–∏, —Ä–∞–∑–¥–µ–ª–µ–Ω–Ω—ã–µ –∑–∞–ø—è—Ç—ã–º–∏:'
        back_button_text = '–ù–∞–∑–∞–¥'

    reply_markup = InlineKeyboardMarkup([[InlineKeyboardButton(back_button_text, callback_data='back')]])
    update.callback_query.edit_message_text(message, reply_markup=reply_markup)

    return 'add_keywords'

def handle_keywords(update: Update, context):
    lang = context.user_data.get('lang', 'en')

    if lang == 'en':
        message = 'Keywords added:'
        back_button_text = 'Back'
    else:
        message = '–î–æ–±–∞–≤–ª–µ–Ω—ã –∫–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞:'
        back_button_text = '–ù–∞–∑–∞–¥'

    keywords = update.message.text.split(',')

    # –æ—á–∏—â–∞–µ–º —Å–ø–∏—Å–æ–∫ –∫–ª—é—á–µ–≤—ã—Ö —Å–ª–æ–≤ –∏ –¥–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–µ
    context.user_data['keywords'] = [keyword.strip() for keyword in keywords]

    reply_markup = InlineKeyboardMarkup([[InlineKeyboardButton(back_button_text, callback_data='back')]])
    update.message.reply_text(f"{message} {keywords}", reply_markup=reply_markup)

    return -1

def delete_all_keywords_callback(update: Update, context):
    lang = context.user_data.get('lang', 'en')

    if lang == 'en':
        message = 'Are you sure you want to delete all keywords?'
        yes_button_text = 'Yes'
        no_button_text = 'No'
        back_button_text = 'Back'
    else:
        message = '–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –≤—Å–µ –∫–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞?'
        yes_button_text = '–î–∞'
        no_button_text = '–ù–µ—Ç'
        back_button_text = '–ù–∞–∑–∞–¥'

    reply_markup = InlineKeyboardMarkup([[InlineKeyboardButton(yes_button_text, callback_data='delete_all_keywords_yes'),
                                           InlineKeyboardButton(no_button_text, callback_data='delete_all_keywords_no')], 
                                          [InlineKeyboardButton(back_button_text, callback_data='back')]])
    update.callback_query.edit_message_text(message, reply_markup=reply_markup)

def delete_all_keywords_yes_callback(update: Update, context):
    lang = context.user_data.get('lang', 'en')

    if lang == 'en':
        message = 'All keywords have been deleted.'
        back_button_text = 'Back'
    else:
        message = '–í—Å–µ –∫–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞ –±—ã–ª–∏ —É–¥–∞–ª–µ–Ω—ã.'
        back_button_text = '–ù–∞–∑–∞–¥'

    context.user_data['keywords'] = []

    reply_markup = InlineKeyboardMarkup([[InlineKeyboardButton(back_button_text, callback_data='back')]])
    update.callback_query.edit_message_text(message, reply_markup=reply_markup)

def chats_callback(update: Update, context):
    lang = context.user_data.get('lang', 'en')

    if lang == 'en':
        message = 'Here are your chats:'
        add_chats_button_text = 'Add new chats'
        back_button_text = 'Back'
    else:
        message = '–í–æ—Ç –≤–∞—à–∏ —á–∞—Ç—ã:'
        add_chats_button_text = '–î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–µ —á–∞—Ç—ã'
        back_button_text = '–ù–∞–∑–∞–¥'

    chats = context.user_data.get('chats', [])

    if chats:
        chats_list = '\n'.join(chats)
        reply_markup = InlineKeyboardMarkup([[InlineKeyboardButton(add_chats_button_text, callback_data='add_chats')],
                                              [InlineKeyboardButton(back_button_text, callback_data='back')]])
        update.callback_query.edit_message_text(f"{message}\n{chats_list}", reply_markup=reply_markup)
    else:
        reply_markup = InlineKeyboardMarkup([[InlineKeyboardButton(add_chats_button_text, callback_data='add_chats')],
                                              [InlineKeyboardButton(back_button_text, callback_data='back')]])
        update.callback_query.edit_message_text(f"{message}\n–£ –≤–∞—Å –Ω–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω–Ω—ã—Ö —á–∞—Ç–æ–≤.", reply_markup=reply_markup)

def add_chats_callback(update: Update, context):
    lang = context.user_data.get('lang', 'en')

    if lang == 'en':
        message = 'Please enter the name of the chats you want to add, separated by a comma:'
        back_button_text = 'Back'
    else:
        message = '–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ —á–∞—Ç–æ–≤, –∫–æ—Ç–æ—Ä—ã–µ –≤—ã —Ö–æ—Ç–∏—Ç–µ –¥–æ–±–∞–≤–∏—Ç—å, —Ä–∞–∑–¥–µ–ª–µ–Ω–Ω—ã–µ –∑–∞–ø—è—Ç—ã–º–∏:'
        back_button_text = '–ù–∞–∑–∞–¥'

    reply_markup = InlineKeyboardMarkup([[InlineKeyboardButton(back_button_text, callback_data='back')]])
    update.callback_query.edit_message_text(message, reply_markup=reply_markup)

    return 'add_chats'

def handle_chats(update: Update, context):
    lang = context.user_data.get('lang', 'en')

    if lang == 'en':
        message = 'Chats added:'
        back_button_text = 'Back'
    else:
        message = '–î–æ–±–∞–≤–ª–µ–Ω—ã —á–∞—Ç—ã:'
        back_button_text = '–ù–∞–∑–∞–¥'

    chats = update.message.text.split(',')

    # –æ—á–∏—â–∞–µ–º —Å–ø–∏—Å–æ–∫ —á–∞—Ç–æ–≤ –∏ –¥–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–µ
    context.user_data['chats'] = [chat.strip() for chat in chats]
    reply_markup = InlineKeyboardMarkup([[InlineKeyboardButton(back_button_text, callback_data='back')]])
    update.message.reply_text(f"{message} {chats}", reply_markup=reply_markup)

    return -1

    
def notify_user(context, lead):
    lang = context.user_data.get('lang', 'en')
    chats = context.user_data.get('chats', [])

    if lang == 'en':
        message = f"You have a new lead:\n{lead}"
    else:
        message = f"–£ –≤–∞—Å –Ω–æ–≤—ã–π –ª–∏–¥:\n{lead}"

    for chat_id in chats:
        try:
            context.bot.send_message(chat_id=chat_id, text=message, reply_markup=InlineKeyboardMarkup([[InlineKeyboardButton('Reply', url='https://telegram.me/' + context.bot.username)]]))
        except Exception as e:
            print(f"Error while sending message to chat {chat_id}: {str(e)}")

def handle_message(update: Update, context: CallbackContext):
    state = context.user_data.get('state', -1)

    # –æ–±—Ä–∞–±–æ—Ç–∫–∞ –∫–æ–º–∞–Ω–¥—ã /start
    if update.message.text == '/start':
        lang_keyboard = [[KeyboardButton('üá∫üá∏ English'), KeyboardButton('üá∑üá∫ –†—É—Å—Å–∫–∏–π')]]
        update.message.reply_text("Please choose a language / –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ —è–∑—ã–∫:", reply_markup=ReplyKeyboardMarkup(lang_keyboard, one_time_keyboard=True))
        return 'choose_language'

    # –æ–±—Ä–∞–±–æ—Ç–∫–∞ –∫–æ–º–∞–Ω–¥—ã /help
    if update.message.text == '/help':
        lang = context.user_data.get('lang', 'en')

        if lang == 'en':
            message = "This bot allows you to find leads in your Telegram chats.\n\n"
            message += "You can add keywords to search for, and then add chats where the bot should search for these keywords.\n\n"
            message += "You can also delete all keywords and view or add new chats.\n\n"
            message += "To get started, click on the 'Keywords' or 'Chats' buttons in the main menu."
        else:
            message = "–≠—Ç–æ—Ç –±–æ—Ç –ø–æ–∑–≤–æ–ª—è–µ—Ç –Ω–∞—Ö–æ–¥–∏—Ç—å –ª–∏–¥–æ–≤ –≤ –≤–∞—à–∏—Ö —á–∞—Ç–∞—Ö Telegram.\n\n"
            message += "–í—ã –º–æ–∂–µ—Ç–µ –¥–æ–±–∞–≤–ª—è—Ç—å –∫–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞ –¥–ª—è –ø–æ–∏—Å–∫–∞ –∏ –∑–∞—Ç–µ–º –¥–æ–±–∞–≤–ª—è—Ç—å —á–∞—Ç—ã, –≤ –∫–æ—Ç–æ—Ä—ã—Ö –±–æ—Ç –¥–æ–ª–∂–µ–Ω –∏—Å–∫–∞—Ç—å —ç—Ç–∏ –∫–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞.\n\n"
            message += "–í—ã —Ç–∞–∫–∂–µ –º–æ–∂–µ—Ç–µ —É–¥–∞–ª–∏—Ç—å –≤—Å–µ –∫–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞ –∏ –ø—Ä–æ—Å–º–æ—Ç—Ä–µ—Ç—å –∏–ª–∏ –¥–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–µ —á–∞—Ç—ã.\n\n"
            message += "–ß—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å, –Ω–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫–∏ '–ö–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞' –∏–ª–∏ '–ß–∞—Ç—ã' –≤ –≥–ª–∞–≤–Ω–æ–º –º–µ–Ω—é."

        update.message.reply_text(message)
        return -1

    # –æ–±—Ä–∞–±–æ—Ç–∫–∞ —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
    if state == 'add_keywords':
        return handle_keywords(update, context)
    elif state == 'add_chats':
        return handle_chats(update, context)

    # –æ–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–∞–∂–∞—Ç–∏–π –Ω–∞ –∫–Ω–æ–ø–∫–∏
    if update.callback_query:
        callback_data = update.callback_query.data

        if callback_data == 'back':
            return back_callback(update, context)
        elif callback_data == 'keywords':
            return keywords_callback(update, context)
        elif callback_data == 'add_keywords':
            return add_keywords_callback(update, context)
        elif callback_data == 'delete_all_keywords':
            return delete_all_keywords_callback(update, context)
        elif callback_data == 'delete_all_keywords_yes':
            return delete_all_keywords_yes_callback(update, context)
        elif callback_data == 'chats':
            return chats_callback(update, context)
        elif callback_data == 'add_chats':
            return add_chats_callback(update, context)

    # –µ—Å–ª–∏ –Ω–∏–∫–∞–∫–æ–µ —É—Å–ª–æ–≤–∏–µ –Ω–µ –≤—ã–ø–æ–ª–Ω–∏–ª–æ—Å—å, —Ç–æ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º —Ç–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    return state
def main():
    updater = Updater(token=TOKEN, use_context=True)
    dispatcher = updater.dispatcher

    # –æ–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π –∏ –Ω–∞–∂–∞—Ç–∏–π –Ω–∞ –∫–Ω–æ–ø–∫–∏
    dispatcher.add_handler(CommandHandler('start', handle_message))
    dispatcher.add_handler(CommandHandler('help', handle_message))
    dispatcher.add_handler(MessageHandler(Filters.text & ~Filters.command, handle_message))
    dispatcher.add_handler(CallbackQueryHandler(handle_message))

    # –∑–∞–ø—É—Å–∫ –±–æ—Ç–∞
    updater.start_polling()
    updater.idle()


